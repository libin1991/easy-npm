## swan-store

[完整演示DEMO](https://github.com/libin1991/swan-store)

## 背景 
需求场景：
> 小程序中有AB两个页面，A属于商品列表页，B属于商品编辑页，A页面点击编辑商品需要将商品数据传输到B页面。

解决方案：
-  利用app.js globalData，设置公共变量      缺点：**页面间数据不是同步的，数据来源不清晰**
- 利用storage，    缺点：**大小限制，分同步异步，数据命名冲突**
- 利用事件总线EventBus      缺点：**功能单一**
- 自己实现一套类似redux或者vuex的状态管理工具

参考vuex API为小程序增加轻量级状态管理并提供页面间通信接口,**解决跨页面数据共享问题**,支持watch和computed功能

###  APi

所有的共享状态都以$开头

```
app.store.install(this);    // 注册使用 当前页面连接vuex
         
console.log(this.data.$state.counter); 
console.log(app.store.getter);      // 获取getter

app.store.commit('count', 1);     // 触发同步事件
app.store.dispatch('countAsync', 1).then(() => {   // 触发异步事件
    app.store.setState({
        counter: 955
    });
});

app.store.replaceState({   // 替换store
    counter: 955
});

app.postMessage('other', {   // 跨页面通信，事件总线精简版
    type: 'msg',
    data: 'message from page1'
});

var subscribe = app.store.subscribe((type, state) => {    // 订阅commit日志打印
    console.log(type, state);
});

subscribe();   // 清除subscribe 订阅
```

### 模板取值
> **state和getter前用$**

```html
<view>{{$state.counter}}</view>
<view>{{$state.arr}}</view>
<view>{{$getter.arrLength}}</view>
```


### 使用
```javascript
// app.js
import Store from './easy-store';

const store = new Store({
    state: {
        counter: 0,
        arr: [1, 2, 3, 4, 5, 6, 7]
    },
    mutations: {
        count(state, payload) {
            return state.counter += payload;
        },
    },
    actions: {
        countAsync(store, payload) {
            return new Promise(resolve => {
                setTimeout(() => {
                    store.commit('count', payload);
                    resolve();
                }, 2000);
            });
        },
    },
    getters: {
        arrLength: (state) => {
            return state.arr.length;
        }
    }
});

App({
    store,
    // 简化postMessage调用
    postMessage: store.postMessage.bind(store)
});

// page1
<view>{{$state.counter}}</view>
<view>{{$state.arr}}</view>
<view>{{$getter.arrLength}}</view>

<view>{{tag}}</view>

<view>{{test2}}</view>    // 计算属性
<view>{{test3}}</view>    // 计算属性


const app = getApp();
Page({data: {
        tag: '测试',
        test: {
            a: 100,
            b: 200
        }
    },
    computed: {   // 计算属性
        test2() {
            return this.data.test.a + 'Test2'
        },
        test3() {
            return this.data.test.b + 'Test3'
        }
    },
    watch: {
        tag(newVal) {
            console.log('test发生变化');
        }
    },
    onLoad() {
    
        app.store.install(this);    // 注册使用 当前页面连接vuex
         
        console.log(this.data.$state.counter); 
        console.log(app.store.getter);      // 获取getter

        app.store.commit('count', 1);
        app.store.dispatch('countAsync', 1).then(() => {
            app.store.setState({
                counter: 955
            });
        });

        app.store.replaceState({
            counter: 955
        });

        app.postMessage('other', {
            type: 'msg',
            data: 'message from page1'
        });
    }
});



// page2
<view>{{$state.counter}}</view>
<view>{{$state.arr}}</view>
<view>{{$getter.arrLength}}</view>


Page({
    onLoad() {
        app.store.install(this);    // 注册使用 
        console.log(this.data.$state.counter);
    },
    onMessage(data) {   // 接受外部通信事件，类似于浏览器postMessage
        console.log(data);
    }
});
```



